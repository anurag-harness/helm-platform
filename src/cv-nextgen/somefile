---
# Source: cv-nextgen/templates/pdb.yaml
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: cv-nextgen
  namespace: default
spec:
  minAvailable: "50%"
  selector:
   matchLabels:
    app: cv-nextgen
---
# Source: cv-nextgen/templates/config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: cv-nextgen
  namespace: default
data:
  DEPLOY_MODE: KUBERNETES_ONPREM
  ENV: KUBERNETES_ONPREM
  LOGGING_LEVEL: INFO
  MANAGER_URL: http://harness-manager.default.svc.cluster.local:9090/
  NG_MANAGER_URL: http://ng-manager.default.svc.cluster.local:7090/
  MEMORY: "4096"
  STACK_DRIVER_LOGGING_ENABLED: "false"
  VERIFICATION_PORT: "6060"
  VERIFICATION_SERVICE_SECRET: 59MR5RlVARcdH7zb7pNx6GzqiglBmXR8
  NOTIFICATION_BASE_URL: http://platform-service.default.svc.cluster.local:9005/api/
  SHOULD_CONFIGURE_WITH_NOTIFICATION: "true"
  PORTAL_URL: 
  MANAGER_CLIENT_BASEURL: http://harness-manager.default.svc.cluster.local:9090/
  EVENTS_FRAMEWORK_REDIS_URL: 'redis://localhost:6379'
  EVENTS_FRAMEWORK_USE_SENTINEL: "true"
  EVENTS_FRAMEWORK_SENTINEL_MASTER_NAME: 'harness-redis'
  EVENTS_FRAMEWORK_REDIS_SENTINELS: 'redis://redis-sentinel-harness-announce-0.default:26379,redis://redis-sentinel-harness-announce-1.default:26379,redis://redis-sentinel-harness-announce-2.default:26379'
  SHOULD_CONFIGURE_WITH_PMS: "true"
  PMS_TARGET: pipeline-service:12011
  PMS_AUTHORITY: pipeline-service:12011
  GRPC_SERVER_PORT: "9979"
  CACHE_CONFIG_REDIS_URL: 'redis://localhost:6379'
  CACHE_BACKEND: "REDIS"
  CACHE_CONFIG_REDIS_SENTINELS: 'redis://redis-sentinel-harness-announce-0.default:26379,redis://redis-sentinel-harness-announce-1.default:26379,redis://redis-sentinel-harness-announce-2.default:26379'
  CACHE_CONFIG_SENTINEL_MASTER_NAME: "harness-redis"
  CACHE_CONFIG_USE_SENTINEL: "true"
  MOCK_ACCESS_CONTROL_SERVICE: "false"
  ACCESS_CONTROL_BASE_URL:  http://access-control.default.svc.cluster.local:9006/api/
  ACCESS_CONTROL_ENABLED: "true"
---
# Source: cv-nextgen/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: cv-nextgen
  namespace: default
  labels:
    helm.sh/chart: cv-nextgen-0.3.1
    app.kubernetes.io/name: cv-nextgen
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/version: "0.0.1"
    app.kubernetes.io/managed-by: Helm
spec:
  ports:
    - name: cv
      port: 6060
      protocol: TCP
      targetPort: 6060
    - name: grpc-cv-nextgen
      port: 9979
      protocol: TCP
      targetPort: 9979
  selector:
    app.kubernetes.io/name: cv-nextgen
    app.kubernetes.io/instance: release-name
  type: ClusterIP
---
# Source: cv-nextgen/templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cv-nextgen
  namespace: default
  labels:
    helm.sh/chart: cv-nextgen-0.3.1
    app.kubernetes.io/name: cv-nextgen
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/version: "0.0.1"
    app.kubernetes.io/managed-by: Helm
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: cv-nextgen
      app.kubernetes.io/instance: release-name
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  template:
    metadata:
      annotations:
        checksum/config: e4859cc050e02e2f6892b60e51dbadf94c099c74ff798519b1e99e39cb458e75
      labels:
        app.kubernetes.io/name: cv-nextgen
        app.kubernetes.io/instance: release-name
    spec:
      
      
      serviceAccountName: harness-default
      securityContext:
        {}
      initContainers:
      - name: wait-for-harness-manager
        image: docker.io/harness/helm-init-container:latest
        imagePullPolicy: IfNotPresent
        args:
          - "pod"
          - "-lapp=harness-manager"
      containers:
        - name: cv-nextgen
          image: docker.io/harness/cv-nextgen-signed:76019
          imagePullPolicy: IfNotPresent
          securityContext:
            runAsNonRoot: true
            runAsUser: 65534
          env:            
            - name: MONGO_USER
              valueFrom:
                secretKeyRef:
                  name: 
                  key: smp-play-admin
            - name: MONGO_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: 
                  key: vxI5iie8yPB0JiGB
            - name: MONGO_URI
              value: mongodb+srv://${MONGO_USER}:$(MONGO_PASSWORD)@smp-ha-dr-0-pri.u2poo.mongodb.net/cvng-harness?
            - name : NOTIFICATION_MONGO_URI
              value: mongodb+srv://${MONGO_USER}:$(MONGO_PASSWORD)@smp-ha-dr-0-pri.u2poo.mongodb.net/notifications?
            - name: PMS_MONGO_URI
              value: mongodb+srv://${MONGO_USER}:$(MONGO_PASSWORD)@smp-ha-dr-0-pri.u2poo.mongodb.net/pms-harness?
          envFrom:
            - configMapRef:
                name: cv-nextgen
          resources:
            limits:
              cpu: 1
              memory: 6144Mi
            requests:
              cpu: 1
              memory: 6144Mi
          readinessProbe:
            httpGet:
              path: /cv/api/health
              port: cv
            initialDelaySeconds: 60
            periodSeconds: 5
          livenessProbe:
            httpGet:
              path: /cv/api/health
              port: cv
            initialDelaySeconds: 300
            periodSeconds: 10
            failureThreshold: 2
          ports:
            - name: cv
              containerPort: 6060
              protocol: "TCP"
            - name: grpc-cv-ng
              containerPort: 9979
              protocol: "TCP"
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - cv-nextgen
            topologyKey: "kubernetes.io/hostname"
---
# Source: cv-nextgen/templates/hpa.yaml
apiVersion: autoscaling/v1
kind: HorizontalPodAutoscaler
metadata:
  name: cv-nextgen
  namespace: default
  labels:
    helm.sh/chart: cv-nextgen-0.3.1
    app.kubernetes.io/name: cv-nextgen
    app.kubernetes.io/instance: release-name
    app.kubernetes.io/version: "0.0.1"
    app.kubernetes.io/managed-by: Helm
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: cv-nextgen
  minReplicas: 1
  maxReplicas: 100
  targetCPUUtilizationPercentage : 80
